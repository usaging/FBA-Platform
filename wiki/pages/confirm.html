{% extends "layout.html" %}

{% block title %}模型配置展示{% endblock %}

{% block page_content %}
<link href="{{ url_for('static', filename='css/base.css') }}" rel="stylesheet">

<div class="main" style="padding-top: 10px">
    <div class="feature">
        <div class="search-container" style="justify-content: flex-start;">
            <button id="clear-btn" class="search-btn">清空配置</button>
            <button id="ensure-btn" class="search-btn">确定提交</button>
        </div>
    </div>
    <div class="content">
        <!-- 美化的模型ID显示 -->
        <div class="model-id-display">
            <i class="fa-solid fa-database"></i>
            <span id="model-id-text">Loading model ID...</span>
        </div>

        <!-- 表格容器，用于水平排布 -->
        <div class="table-container">
            <!-- Objective 表格 -->
            <div class="table-wrapper">
                <h2 style = "color:var(--primary-color)">Objective Setting</h2>
                <table id="objective-table">
                    <thead>
                        <tr>
                            <th>reaction ID</th>
                            <th>reaction weight</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Deleted Genes 表格 -->
            <div class="table-wrapper" id="deleted-genes" >
                <h2 style = "color:var(--primary-color)">Deleted Genes</h2>
                <table id="deleted-genes-table">
                    <thead>
                        <tr>
                            <th>Gene</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Modified Reactions 表格 -->
            <div class="table-wrapper">
                <h2 style = "color:var(--primary-color)">Modified Reactions</h2>
                <table id="modified-reactions-table">
                    <thead>
                        <tr>
                            <th>Reaction</th>
                            <th>Lower Bound</th>
                            <th>Upper Bound</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // 从后端接口获取 JSON 配置
    fetch('/fba-config.json')
        .then(res => res.json())
        .then(data => {
            // 显示模型ID
            document.getElementById('model-id-text').textContent = data.model || "未选择模型";



            // 填充 Objective 表格
            const objTbody = document.querySelector('#objective-table tbody');
            if (data.objective.length === 0) {
                const objRow = document.createElement('tr');

                objRow.innerHTML = `
                <td>${'Biomass'}</td>
                <td>100%</td> <!-- 默认权重为1.0 -->
            `;
                objTbody.appendChild(objRow);
            }
            else {
                data.weights.forEach(reaction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${reaction.reaction}</td>
                    <td>${reaction.weight} %</td>
                `;
                    objTbody.appendChild(row);
                });
            }

            // 填充 Deleted Genes
            const delTbody = document.querySelector('#deleted-genes-table tbody');
            data.deleted_genes.forEach(gene => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${gene}</td>`;
                delTbody.appendChild(row);
            });

            // 填充 Modified Reactions
            const modTbody = document.querySelector('#modified-reactions-table tbody');
            data.modified_reactions.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.reaction}</td>
                    <td>${item.lower_bound}</td>
                    <td>${item.upper_bound}</td>
                `;
                modTbody.appendChild(row);
            });

        });

    // 添加清空按钮点击事件
    document.getElementById('clear-btn').addEventListener('click', function () {
        if (confirm('确定要清空所有配置吗？')) {
            localStorage.removeItem('selectedModelId');
            document.getElementById('modelIdText').textContent = "未选择模型";
            localStorage.removeItem('selectedGenes');
            localStorage.removeItem('selectedReactions');
            localStorage.removeItem('selectedReactionId');
            fetch('/clear-config', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        console.error('清空配置失败');
                    }
                });
        }
    });

    // 添加确定提交按钮点击事件
    document.getElementById('ensure-btn').addEventListener('click', function () {
        if (confirm('确定要提交所有配置吗？')) {
            fetch('/config', { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        alert('配置提交成功');
                        window.location.href = '/result';
                    } else {
                        alert('提交失败');
                    }
                });
        }
    });


</script>

<style>
    /* 模型ID显示样式 */
    .model-id-display {
        display: inline-block;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
        min-width: 50px;
        /* 根据实际情况调整 */
        font-size: 1.2em;
        padding: 10px 15px;
        background-color: rgba(0, 123, 255, 0.1);
        border-radius: 4px;
        color: var(--primary-color);
    }

    .model-id-display i {
        font-size: 1.5em;
    }

    /* 表格容器，用于水平排布 */
    .table-container {
        display: flex;
        gap: 30px;
    }

    /* 表格包裹器 */
    .table-wrapper {
        display: inline-block;
        vertical-align: top;
        width: max-content;
    }

    /* 表格基础样式 */
    table {
        /* border-collapse: collapse;
        width: 100%;
        margin-bottom: 1.5em; */
        table-layout: fixed;
        width: 100%;
        max-width: 100%;
        overflow: hidden;
        border-collapse: collapse;
        margin-bottom: 0;
        margin: 15px 0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: block;
        overflow-x: auto;
        height: calc(100% - 30px);
    }

    th,
    td {
        width: 120px;
        /* 默认宽度 */
        padding: 12px 15px;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid #ddd;
    }

    th {
        /* background-color: #f5f5f5; */
        text-align: center;
        background-color: var(--primary-light);
        color: var(--primary-dark);
        position: sticky;
        top: 0;
    }

    /* 针对特定表格的列宽度调整 */
    #objective-table th,
    #objective-table td {
        width: 150px;
        /* 调整 Objective 表格列宽 */
    }

    #deleted-genes-table th,
    #deleted-genes-table td {
        width: 130px;
        /* 调整 Deleted Genes 表格列宽 */
    }

    #modified-reactions-table th,
    #modified-reactions-table td {
        width: 120px;
        /* 调整 Modified Reactions 表格列宽 */
    }

    /* 针对特定列的宽度调整 */
    #modified-reactions-table th:nth-child(1),
    #modified-reactions-table td:nth-child(1) {
        width: 180px;
        /* 调整第一列（Reaction）宽度 */
    }

    /* 暗黑模式样式 */
    .dark .model-id-display {
        background-color: rgba(0, 123, 255, 0.2);
        color: var(--primary-light);
    }

    .dark th {
        background-color: #444;
        color: var(--primary-color);
        border-bottom: 0.5px solid white;
    }

    .dark #objective-table th,
    .dark #deleted-genes-table th,
    .dark #modified-reactions-table th {
        border-bottom: 0.5px solid white;
    }


    .dark td {
        border-color: #555;
    }

    .dark tr:hover td {
        background-color: #444;
    }

    /* 按钮样式 */
    .search-btn {
        padding: 8px 16px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
    }

    .search-btn:hover {
        background-color: var(--primary-dark);
    }
</style>
{% endblock %}